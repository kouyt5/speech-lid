defaults:
  - base: custom  # 基本的日志配置

model:
  model_name: &model_name >- 
    lr_${module.optimizer_param.lr}_dr_${model.dropout}_bs_${data.sampler_common.train_batch_size}_conform_${model.conformer_linear}
  
  conformer_pure: true

  num_layers: 1  # LSTM层数
  hidden_dim: 32  # 语种识别模型隐藏层维度
  use_cer: true
  conformer_linear: true
  dropout: 0.0  # 最后的线性映射层dropout
  linear_dim: 144  # 最后线性层输入维度
  n_blocks: 14
  win_len: 0.025
  hop_length: 0.01
  sr: 16000
  n_mels: 80
  encoder_dim: 144  # 和linear_dim保持一致
  t_mask_prob:  0.05  # 时域mask概率
  f_mask: 27
  mask_times: 2  # mask次数
  dim_head: 64  # att head 维度
  heads: 4  # att head数
  ff_mult: 4
  conv_expansion_factor: 2
  conv_kernel_size: 31
  attn_dropout: 0.0
  ff_dropout: 0.0
  conv_dropout: 0.0
  double_swish: false

supervised: true  # 走监督训练module

module:
  optimizer_name: novograd
  optimizer_param:
    # momentum: 0.9
    weight_decay: 0.00001
    # nesterov: false
    lr: 0.01
  scheduler: tristage  # tristage
  scheduler_param:
    mode: min
    factor: 0.1
    patience: 5
    cooldown: 3
    min_lr: 0.0005
  interval: 50
  freeze_tranformer_epoch: -1
  freeze_encoder_epoch: -1
  froze_wav2vec_model_epoch: -1

data:
  source: xf_asr
  dataloader_params:
    pin_memory: true
    num_workers: 6
    prefetch_factor: 10
    train_batch_sampler: null
    val_batch_sampler: null
    test_batch_sampler: null
  langs:
    -
      train_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Persian/train7k.label
      # train_manifest: /home/cc/workdir/code/lid/data/xf/data/Persian/dev1.label
      val_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Persian/dev100.label
      test_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Persian/dev100.label
      lang: Persian
      id: 0
      vocab: /home/cc/workdir/code/lid/data/xf2/data/Persian-vocab.txt
    -
      # train_manifest: /home/cc/workdir/code/lid/data/xf/data/Swahili/dev1.label  # 6394
      train_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Swahili/train63.label
      # val_manifest: /home/cc/workdir/data/common-voice/cv-corpus-9.0-2022-04-27/zh-TW/dev.tsv  # 4619
      val_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Swahili/dev100.label
      test_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Swahili/dev100.label
      lang: Swahili
      id: 1
      vocab: /home/cc/workdir/code/lid/data/xf2/data/Swahili-vocab.txt
    -
      # train_manifest: /home/cc/workdir/code/lid/data/xf/data/Vietnamese/dev1.label
      train_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Vietnamese/train67.label
      val_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Vietnamese/dev100.label
      test_manifest: /home/cc/workdir/code/lid/data/xf2/data/train/Vietnamese/dev100.label
      lang: Vietnamese
      id: 2
      vocab: /home/cc/workdir/code/lid/data/xf2/data/Vietnamese-vocab.txt

  sampler_common:
    train_batch_size: 4
    val_batch_size: 4
    test_batch_size: 1
  max_duration: 12

trainer:
  total_epoch: 40
  gpu_id: 0
  local_rank: 0
  world_size: 1
  ddp: false
  backend: 'nccl'
  init_method: env://  # 目前只支持env初始化
  accumulate_grad: 4
  master_addr: localhost
  master_port: 11488
  use_amp: false
  use_swa: false
  eval_interval: 1
  train_data_factor: 1
  log_interval: 10
  checkpoint_path: null  # trainer 的checkpoint
  resume_train_states: True

logger:
  wandb:
    project: xf_asr_zero
    entity: kouyt5
    name: *model_name
    wandb_id: null

stage: train  # test, train